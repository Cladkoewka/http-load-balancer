# HTTP Load Balancer

Этот проект реализует балансировщик нагрузки на основе reverse proxy с поддержкой алгоритмов выбора бэкендов, ограничения скорости (rate limiting), логирования запросов и проверки здоровья серверов. Проект может быть использован для балансировки нагрузки между несколькими бэкенд-серверами.

## Описание

Проект включает следующие основные компоненты:

1. **Балансировщик нагрузки (Load Balancer)**: 
    - Реализует два алгоритма балансировки: *round-robin* и *random*.
    - Проводит проверку состояния (health check) бэкендов и автоматически исключает неработающие серверы.

2. **Rate Limiter**:
    - Осуществляет ограничение по количеству запросов от одного клиента (IP), используя алгоритм *Token Bucket*.
    - Конфигурируемая скорость пополнения токенов и ёмкость ведра для каждого клиента.

3. **Reverse Proxy**:
    - Перенаправляет запросы от клиента на выбранный бэкенд.
    - Логирует каждый запрос с указанием метода, пути, клиента и статуса ответа.

4. **Logging**:
    - Логирует запросы и ошибки с помощью библиотеки `slog`.

5. **Конфигурация**:
    - Конфигурируется с помощью YAML-файла, который задаёт порт и список бэкенд-серверов.

## Структура проекта

### Основные пакеты

- **main** — основной пакет, запускающий сервер с настройкой логирования и конфигурации.
- **server** — содержит код для запуска HTTP-сервера, middleware для логирования и ограничения скорости.
- **balancer** — код для реализации балансировщика нагрузки, включая выбор алгоритма и проверку здоровья серверов.
- **ratelimiter** — код для реализации ограничения скорости с использованием токенов.
- **proxy** — код для реализации reverse proxy, который перенаправляет запросы на выбранный бэкенд.
- **logger** — логирование с помощью библиотеки `slog`.
- **config** — загрузка конфигурации из YAML-файла.

### Основные файлы

- **main.go** — точка входа, запускающая сервер.
- **config.yaml** — файл конфигурации, задающий настройки приложения.
- **load-balancer.go** — балансировщик нагрузки.
- **ratelimiter.go** — механизм ограничения запросов.
- **proxy.go** — механизм проксирования запросов.
- **logger.go** — инициализация логирования.
- **server.go** — HTTP-сервер и middleware.

## Как запустить

1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/Cladkoewka/http-load-balancer.git
   cd http-load-balancer
   ```

2. Установите зависимости:
   ```bash
   go mod tidy
   ```

3. Создайте файл конфигурации `config.yaml` в корне проекта. Пример:
   ```yaml
   port: 8080
   backendURLs:
     - "http://localhost:9001"
     - "http://localhost:9002"
   ```

4. Запустите несколько тестовых бэкенд-серверов

  Файл `test_backend/main.go` предоставляет простой сервер, который выводит, с какого порта пришёл ответ.
  
  Для запуска двух тестовых серверов:
  
  **Unix/Linux/MacOS**
  ```bash
  PORT=9001 go run test_backend/main.go
  PORT=9002 go run test_backend/main.go
  ```
  
  **Windows (PowerShell)**
  ```powershell
  $env:PORT=9001; go run test_backend/main.go
  $env:PORT=9002; go run test_backend/main.go
  ```
  
  Каждый сервер будет отвечать фразой вида:
  ```
  Hello from test backend on port 9001
  ```

5. Запустите приложение:
   ```bash
   go run main.go
   ```

Балансировщик будет слушать порт, указанный в конфигурации, и перенаправлять запросы на указанные бэкенд-сервера.

## Архитектура

1. **Rate Limiting**: Для каждого клиента (по его IP) создаётся собственное ведро токенов (Token Bucket), которое заполняется с заданной скоростью. Если токены заканчиваются, запросы отклоняются с ошибкой "Too Many Requests".

2. **Load Balancing**: Балансировщик нагрузки выбирает бэкенд для обработки запроса в зависимости от выбранного алгоритма:
   - *Round Robin*: последовательно выбирает серверы.
   - *Random*: случайным образом выбирает сервер.

3. **Health Check**: Периодически проверяется состояние каждого бэкенда. Если сервер не отвечает или возвращает ошибку, он помечается как недоступный, и запросы к нему не перенаправляются.

4. **Logging**: Все входящие HTTP-запросы логируются. Логирование включает информацию о методе, пути запроса, IP клиента и статусе ответа.

5. **Proxy**: Используется стандартная библиотека `httputil` для реализации reverse proxy.

## Важные параметры

- **Port**: Порт, на котором будет работать балансировщик нагрузки.
- **BackendURLs**: Список URL бэкенд-серверов, на которые будут перенаправляться запросы.
- **BucketCapacity**: Ёмкость ведра токенов для ограничения скорости.
- **BucketRefillRate**: Скорость пополнения токенов.
- **HealthCheckRate**: Частота проверки состояния бэкендов.

## Возможные улучшения

- **Graceful Shutdown**: Добавить плавное завершение работы сервера, чтобы корректно завершить все текущие запросы перед остановкой.
- **API для настройки лимитов**: Создать API для изменения лимитов запросов в реальном времени.
- **Поддержка других алгоритмов балансировки**: Например, *Least Connections* или *IP Hash*.




